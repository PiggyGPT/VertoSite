import {
  ArrowRight,
  Workflow,
  Coins,
  Globe2,
  ShieldCheck,
  Phone,
  Calendar,
} from "lucide-react";
import { Link } from "wouter";
import { useState, useEffect, useRef } from "react";

/**
 * A custom hook to manage a simple modal state.
 * It returns a function to open the modal and the modal component itself.
 */
const useCalendlyModal = () => {
  const [isOpen, setIsOpen] = useState(false);

  const openModal = () => setIsOpen(true);
  const closeModal = () => setIsOpen(false);

  /**
   * A simple demo modal.
   * In a real app, this would likely trigger an external script like Calendly.
   */
  const CalendlyModal = ({ title }: { title: string }) => {
    if (!isOpen) return null;
    return (
      <div
        className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm p-4 animate-in fade-in duration-300"
        onClick={closeModal}
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
      >
        <div
          className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95 duration-300"
          onClick={(e) => e.stopPropagation()}
        >
          <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
            <h3
              id="modal-title"
              className="text-lg font-semibold text-slate-900 dark:text-white"
            >
              {title}
            </h3>
            <button
              onClick={closeModal}
              className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors"
              aria-label="Close modal"
            >
              ✕
            </button>
          </div>
          <div className="p-8 text-center">
            <div className="w-16 h-16 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4">
              <Phone className="w-8 h-8" />
            </div>
            <p className="text-slate-600 dark:text-slate-400 mb-6 text-sm leading-relaxed">
              This is a demo environment. In production, this would open your
              Calendly or scheduling interface directly.
            </p>
            <button
              onClick={closeModal}
              className="w-full py-2.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-lg font-medium text-sm hover:opacity-90 transition-opacity"
            >
              Return to Demo
            </button>
          </div>
        </div>
      </div>
    );
  };

  return { openModal, CalendlyModal };
};

interface StoryStep {
  title: string;
  subtitle: string;
  icon: React.ComponentType<{ className?: string }>;
  href: string;
  accentColor: string;
}

/**
 * The main Hero Section component.
 * Includes header, subtitle, CTAs, social proof, and an interactive story feature.
 */
export default function HeroSection() {
  const { openModal, CalendlyModal } = useCalendlyModal();
  const [currentStep, setCurrentStep] = useState(0);
  const [isAutoPlaying, setIsAutoPlaying] = useState(true);
  const autoPlayRef = useRef<NodeJS.Timeout | null>(null);

  const storySteps: StoryStep[] = [
    {
      title: "Tokenize",
      subtitle:
        "Enable your systems to automate issuance, redemption and reconciliation with our APIs.",
      icon: Workflow,
      href: "/integrate",
      accentColor: "#EEAA4A",
    },
    {
      title: "Attract Liquidity",
      subtitle:
        "Enable LPs to securely seed dollar stablecoin liquidity and earn yield with our Decentralized Exchange.",
      icon: Coins,
      href: "/liquidity",
      accentColor: "#EF660B",
    },
    {
      title: "Transact Globally",
      subtitle:
        "Enable Traders to easily transact with any bank or wallet with our Router.",
      icon: Globe2,
      href: "/coverage",
      accentColor: "#8F73FE",
    },
    {
      title: "Unlock Growth",
      subtitle:
        "Deploy our full stack on your servers to unlock the Dollar Growth Spiral: Liquidity → Volume → Yield.",
      icon: ShieldCheck,
      href: "/compliance",
      accentColor: "#217DFE",
    },
  ];

  // Effect to handle the auto-play functionality for the story steps
  useEffect(() => {
    if (isAutoPlaying) {
      autoPlayRef.current = setInterval(() => {
        setCurrentStep((prev) => (prev + 1) % storySteps.length);
      }, 5000); // Changed to 5s for a snappier demo
    }
    return () => {
      if (autoPlayRef.current) clearInterval(autoPlayRef.current);
    };
  }, [isAutoPlaying, storySteps.length]);

  // Handler to manually select a step, which also stops auto-play
  const handleStepClick = (index: number) => {
    if (autoPlayRef.current) clearInterval(autoPlayRef.current);
    setIsAutoPlaying(false);
    setCurrentStep(index);
  };

  const activeStory = storySteps[currentStep];
  const activeAccent = activeStory.accentColor;

  return (
    <section className="relative w-full min-h-screen flex flex-col justify-center overflow-hidden text-slate-900 dark:text-white pt-24 pb-16 sm:pt-32 sm:pb-24">
      {/* BACKGROUND - Refined, subtle glows that respect original color intent */}
      <div
        className="absolute inset-0 z-0 pointer-events-none"
        aria-hidden="true"
      >
        {/* Light Mode: Warm golden glow at top-right, more subtle */}
        <div
          className="absolute -top-1/4 right-0 w-1/2 h-1/2 rounded-full blur-[150px] opacity-10 dark:hidden"
          style={{
            background:
              "radial-gradient(circle at center, #EEAA4A, #EF660B, transparent 70%)",
          }}
        />
        {/* Cool glow for both, bottom-left, balances the warm tones */}
        <div
          className="absolute -bottom-1/4 -left-1/4 w-1/2 h-1/2 rounded-full blur-[150px] opacity-5"
          style={{
            background:
              "radial-gradient(circle at center, #8F73FE, #217DFE, transparent 70%)",
          }}
        />
        {/* Dark Mode: Existing subtle base */}
        <div
          className="hidden dark:block absolute -bottom-1/4 left-1/2 -translate-x-1/2 w-[150%] h-[800px] rounded-full blur-[150px] opacity-5"
          style={{
            background:
              "radial-gradient(circle at center, #1A233A, #0A1128, transparent 70%)",
          }}
        />
        {/* Grid overlay - Made more subtle */}
        <div className="absolute inset-0 bg-[url('/grid-light.svg')] dark:bg-[url('/grid-dark.svg')] bg-center [mask-image:linear-gradient(180deg,white,rgba(255,255,255,0))] opacity-10 dark:opacity-3" />
      </div>

      {/* MAIN CONTENT */}
      <div className="relative z-10 w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col items-center">
        {/* HEADER */}
        <div className="text-center max-w-3xl mx-auto">
          <h1 className="font-extrabold text-4xl sm:text-5xl lg:text-6xl xl:text-7xl tracking-tighter mb-6 sm:mb-8 text-slate-900 dark:text-white leading-tight">
            Launch Your Stablecoin.
            <br />
            <span className="text-transparent bg-clip-text bg-gradient-to-r from-slate-800 to-slate-600 dark:from-white dark:to-slate-300">
              Capture Global Dollars.
            </span>
          </h1>

          <p className="text-base sm:text-lg md:text-xl text-slate-600 dark:text-slate-400 max-w-2xl mx-auto leading-relaxed mb-8 sm:mb-10">
            Capture liquidity from the $300B dollar stablecoin market
            <br />
            with our self-hosted, full-stack infrastructure.
          </p>
        </div>

        {/* CTA Buttons */}
        <div className="flex flex-col sm:flex-row flex-wrap justify-center gap-3 sm:gap-4 mb-12 sm:mb-16">
          <button
            onClick={openModal}
            className="group inline-flex items-center justify-center gap-2 px-6 sm:px-7 py-3 rounded-lg font-semibold text-sm text-white
                       transition-all duration-500 ease-out
                       bg-[linear-gradient(90deg,_#EF660B,_#8F73FE,_#217DFE)]
                       bg-[length:200%_auto] hover:bg-[position:100%_0]
                       shadow-lg hover:shadow-xl shadow-black/10 dark:shadow-black/30 hover:-translate-y-0.5"
            data-testid="hero-schedule-demo"
          >
            <Calendar className="w-4 h-4" />
            <span>Schedule Demo</span>
          </button>
          <button
            onClick={openModal}
            className="hidden sm:inline-flex items-center justify-center gap-2 px-6 sm:px-7 py-3 rounded-lg 
                       bg-white dark:bg-slate-800 
                       border border-slate-300 dark:border-slate-700 
                       text-slate-700 dark:text-slate-300 
                       font-semibold text-sm transition-all
                       hover:bg-slate-50 dark:hover:bg-slate-700
                       hover:-translate-y-0.5"
            data-testid="hero-contact-sales"
          >
            <Phone className="w-4 h-4 text-slate-400 dark:text-slate-500" />
            Contact Sales
          </button>
        </div>

        {/* SOCIAL PROOF - Fixed responsiveness */}
        <div className="w-full max-w-4xl">
          <p className="text-center text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-6 sm:mb-7">
            Founded by leaders at
          </p>
          <div className="flex flex-wrap justify-center items-center gap-x-8 sm:gap-x-10 md:gap-x-12 lg:gap-x-16 gap-y-4 
                          grayscale opacity-60 dark:opacity-70">
            {/* Logos are now responsive, maintaining aspect ratio */}
            <div className="h-6 sm:h-7 flex items-center justify-center">
              <img
                src="https://placehold.co/160x24/FFFFFF/CCCCCC?text=Federal+Reserve&font=inter"
                alt="Federal Reserve"
                className="h-full w-auto object-contain dark:invert"
                onError={(e) => (e.currentTarget.src = "https://placehold.co/160x24/FFFFFF/CCCCCC?text=Federal+Reserve&font=inter")}
              />
            </div>
            <div className="h-6 sm:h-7 flex items-center justify-center">
              <img
                src="https://placehold.co/80x24/FFFFFF/CCCCCC?text=GSR&font=inter"
                alt="GSR Markets"
                className="h-full w-auto object-contain dark:invert"
                onError={(e) => (e.currentTarget.src = "https://placehold.co/80x24/FFFFFF/CCCCCC?text=GSR&font=inter")}
              />
            </div>
            <div className="h-6 sm:h-7 flex items-center justify-center">
              <img
                src="https://placehold.co/80x24/FFFFFF/CCCCCC?text=PayPal&font=inter"
                alt="PayPal"
                className="h-full w-auto object-contain dark:invert"
                onError={(e) => (e.currentTarget.src = "https://placehold.co/80x24/FFFFFF/CCCCCC?text=PayPal&font=inter")}
              />
            </div>
            <div className="h-6 sm:h-7 flex items-center justify-center">
              <img
                src="https://placehold.co/80x24/FFFFFF/CCCCCC?text=Microsoft&font=inter"
                alt="Microsoft"
                className="h-full w-auto object-contain dark:invert"
                onError={(e) => (e.currentTarget.src = "https://placehold.co/80x24/FFFFFF/CCCCCC?text=Microsoft&font=inter")}
              />
            </div>
          </div>
        </div>

        {/* INTERACTIVE STORY SECTION - This UI was missing */}
        <div className="w-full max-w-5xl mx-auto mt-16 sm:mt-20 lg:mt-24">
          {/* Tabs for story steps */}
          <div className="flex flex-wrap justify-center border-b border-slate-200 dark:border-slate-800 mb-6">
            {storySteps.map((step, index) => (
              <button
                key={step.title}
                onClick={() => handleStepClick(index)}
                className={`relative flex items-center gap-2 px-3 sm:px-4 py-3 text-sm sm:text-base font-medium transition-colors duration-300 -mb-px ${
                  currentStep === index
                    ? "text-slate-900 dark:text-white"
                    : "text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200"
                }`}
                role="tab"
                aria-selected={currentStep === index}
              >
                <step.icon
                  className={`w-4 h-4 transition-colors ${
                    currentStep === index ? "" : "text-slate-400 dark:text-slate-500"
                  }`}
                  style={{
                    color: currentStep === index ? activeAccent : undefined,
                  }}
                />
                <span>{step.title}</span>
                {/* Active step underline */}
                {currentStep === index && (
                  <span
                    className="absolute bottom-0 left-0 right-0 h-0.5"
                    style={{ backgroundColor: activeAccent }}
                    aria-hidden="true"
                  />
                )}
              </button>
            ))}
          </div>

          {/* Content for active story step */}
          <div className="relative w-full overflow-hidden">
            <div
              key={currentStep} // This key triggers the re-render animation
              className="p-6 sm:p-8 bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700/50 rounded-xl shadow-lg animate-in fade-in duration-500"
              role="tabpanel"
            >
              <h3 className="text-lg sm:text-xl font-semibold text-slate-900 dark:text-white mb-2">
                {activeStory.title}
              </h3>
              <p className="text-slate-600 dark:text-slate-400 text-sm sm:text-base mb-4">
                {activeStory.subtitle}
              </p>
              <Link
                href={activeStory.href}
                className="inline-flex items-center gap-1.5 text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline"
              >
                Learn more <ArrowRight className="w-4 h-4" />
              </Link>
            </div>
          </div>
        </div>
      </div>

      <CalendlyModal title="Schedule a Consultation" />
    </section>
  );
}